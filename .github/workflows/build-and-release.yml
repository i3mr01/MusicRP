name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v2.0.0)'
        required: true
        default: 'v2.0.0'

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore i3mr0-MusicRP.sln
      
    - name: Build solution
      run: dotnet build i3mr0-MusicRP.sln --configuration Release --no-restore
      
    - name: Publish application
      run: dotnet publish i3mr0-MusicRP/i3mr0-MusicRP.csproj --configuration Release --output ./publish --self-contained true --runtime win-x64
      
    - name: Create release archive
      run: |
        Compress-Archive -Path "./publish/*" -DestinationPath "./i3mr0-MusicRP-v${{ github.ref_name }}-win-x64.zip"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: i3mr0-MusicRP-${{ github.ref_name }}-win-x64
        path: ./i3mr0-MusicRP-v${{ github.ref_name }}-win-x64.zip
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: i3mr0-MusicRP-${{ github.ref_name }}-win-x64
        path: ./release
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: i3mr0 MusicRP ${{ github.ref_name }}
        body: |
          ## üéâ i3mr0 MusicRP ${{ github.ref_name }} Release
          
          ### ‚ú® What's New
          - Complete rebranding from AMWin-RP to i3mr0 MusicRP
          - Enhanced AI-powered features and analytics
          - Theme management system with multiple themes
          - Performance monitoring and optimization
          - Custom format support for Discord Rich Presence
          - Modern UI with Fluent Design
          - Comprehensive documentation suite
          
          ### üöÄ Features
          - **Discord Rich Presence**: Show your music in Discord status
          - **Custom Formats**: Create personalized subtitle formats
          - **Theme System**: Multiple beautiful themes
          - **AI Features**: Smart recommendations and analytics
          - **Performance Monitoring**: Real-time performance tracking
          - **Scrobbling**: Last.FM and ListenBrainz integration
          
          ### üì¶ Installation
          1. Download the appropriate release for your system
          2. Extract the files to a folder
          3. Run `i3mr0-MusicRP.exe`
          4. Configure settings through the system tray icon
          
          ### üìã Requirements
          - Windows 10 21H1 or later
          - Microsoft Store version of Apple Music
          - .NET 8.0 Desktop Runtime (included in standard release)
          
          ### üîó Links
          - **Documentation**: [Full Documentation](https://github.com/i3mr0/MusicRP/wiki)
          - **Features**: [Complete Feature List](https://github.com/i3mr0/MusicRP/blob/master/FEATURES.md)
          - **Technical Docs**: [Technical Documentation](https://github.com/i3mr0/MusicRP/blob/master/TECHNICAL_DOCS.md)
          - **Quick Start**: [Quick Start Guide](https://github.com/i3mr0/MusicRP/blob/master/QUICKSTART.md)
          
          ### üêõ Bug Reports
          If you encounter any issues, please report them on our [GitHub Issues](https://github.com/i3mr0/MusicRP/issues) page.
          
          ### üôè Credits
          Based on the excellent work by [PKBeam/AMWin-RP](https://github.com/PKBeam/AMWin-RP)
          Enhanced and customized by i3mr0
          
          **Made with ‚ù§Ô∏è by i3mr0**
        files: ./release/*
        draft: false
        prerelease: false
